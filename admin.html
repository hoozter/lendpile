<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>Admin – Lendpile</title>
  <link rel="icon" href="assets/favicon.ico" type="image/x-icon" />
  <style>
    :root {
      --bg: #f8f9fa;
      --text: #333;
      --border: #e0e0e0;
      --error: #c00;
      --btn-bg: #00A1FF;
      --btn-del: #c00;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #1e1e1e;
        --text: #f0f0f0;
        --border: #444;
        --btn-bg: #1a7fd4;
        --btn-del: #e55;
      }
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); padding: 24px; max-width: 900px; margin: 0 auto; min-height: 100vh; }
    h1 { font-size: 1.35rem; margin-bottom: 1rem; }
    .back { display: inline-block; margin-bottom: 1rem; color: var(--btn-bg); text-decoration: none; }
    .back:hover { text-decoration: underline; }
    .admin-section { margin-bottom: 1.5rem; }
    .admin-section h2 { font-size: 1rem; margin-bottom: 0.5rem; font-weight: 600; }
    .admin-form { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-bottom: 0.75rem; }
    .admin-form label { font-weight: 500; }
    .admin-form input[type="password"],
    .admin-form input[type="email"],
    .admin-form input[type="text"] { padding: 8px 12px; min-width: 200px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); }
    .admin-form button { padding: 8px 16px; border: none; border-radius: 6px; background: var(--btn-bg); color: #fff; cursor: pointer; font-weight: 500; }
    .admin-form button:hover { opacity: 0.9; }
    .admin-form button:disabled { opacity: 0.6; cursor: not-allowed; }
    .admin-form button.btn-secondary { background: var(--border); color: var(--text); }
    .message { margin-bottom: 1rem; padding: 10px 12px; border-radius: 6px; }
    .message.error { background: rgba(200,0,0,0.15); color: var(--error); }
    .message.success { background: rgba(0,160,0,0.15); }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { text-align: left; padding: 10px 12px; border-bottom: 1px solid var(--border); }
    th { font-weight: 600; }
    .btn-del { padding: 6px 12px; border: none; border-radius: 4px; background: var(--btn-del); color: #fff; cursor: pointer; font-size: 13px; }
    .btn-del:hover { opacity: 0.9; }
    .btn-del:disabled { opacity: 0.5; cursor: not-allowed; }
    .meta { font-size: 12px; color: var(--text); opacity: 0.85; }
    .divider { margin: 1.25rem 0; border: 0; border-top: 1px solid var(--border); }
    .logged-in-as { margin-bottom: 0.5rem; font-size: 0.9rem; opacity: 0.9; }
  </style>
</head>
<body>
  <a class="back" href="app.html">← Back to Lendpile</a>
  <h1>Admin – Users</h1>
  <p style="margin-bottom: 1rem;">Only users with the admin role can access this page. You can log in with your Lendpile account (if it’s an admin) or use the API key.</p>

  <div id="admin-logged-in" class="admin-section" style="display: none;">
    <p class="logged-in-as" id="admin-logged-in-email"></p>
    <div class="admin-form">
      <button type="button" id="admin-load-jwt">Load users</button>
      <button type="button" class="btn-secondary" id="admin-logout">Log out</button>
    </div>
  </div>

  <div id="admin-login-section" class="admin-section">
    <h2>Log in with your Lendpile account</h2>
    <p style="margin-bottom: 0.5rem; font-size: 0.9rem;">Use an account that has the admin role. If you have 2FA enabled, you’ll need it here too.</p>
    <form id="admin-login-form" class="admin-form">
      <label for="admin-email">Email</label>
      <input type="email" id="admin-email" required placeholder="you@example.com" autocomplete="email" />
      <label for="admin-password">Password</label>
      <input type="password" id="admin-password" placeholder="Password" autocomplete="current-password" />
      <button type="submit">Log in</button>
    </form>
  </div>

  <hr class="divider" />
  <div class="admin-section">
    <h2>Or use API key</h2>
    <p style="margin-bottom: 0.5rem; font-size: 0.9rem;">If you set ADMIN_TOTP_SECRET in the Worker, you must also enter the current 6-digit code from your authenticator app.</p>
    <div class="admin-form">
      <label for="admin-key">Admin API key</label>
      <input type="password" id="admin-key" placeholder="Your ADMIN_SECRET" autocomplete="off" />
      <label for="admin-totp">TOTP code (6 digits)</label>
      <input type="text" id="admin-totp" placeholder="000000" inputmode="numeric" pattern="[0-9]*" maxlength="6" autocomplete="one-time-code" />
      <button type="button" id="admin-load-key">Load users</button>
    </div>
  </div>

  <div id="admin-message" class="message" style="display: none;"></div>
  <div id="admin-table-wrap" style="display: none;">
    <table>
      <thead>
        <tr>
          <th>Email</th>
          <th>User ID</th>
          <th>Created</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="admin-tbody"></tbody>
    </table>
  </div>

  <script src="config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    (function () {
      const STORAGE_KEY = "lendpile_admin_key";
      const keyInput = document.getElementById("admin-key");
      const totpInput = document.getElementById("admin-totp");
      const loadKeyBtn = document.getElementById("admin-load-key");
      const loadJwtBtn = document.getElementById("admin-load-jwt");
      const logoutBtn = document.getElementById("admin-logout");
      const loginForm = document.getElementById("admin-login-form");
      const adminEmail = document.getElementById("admin-email");
      const adminPassword = document.getElementById("admin-password");
      const loggedInSection = document.getElementById("admin-logged-in");
      const loggedInEmail = document.getElementById("admin-logged-in-email");
      const loginSection = document.getElementById("admin-login-section");
      const msgEl = document.getElementById("admin-message");
      const tableWrap = document.getElementById("admin-table-wrap");
      const tbody = document.getElementById("admin-tbody");

      const supabaseUrl = window.SUPABASE_URL;
      const supabaseAnon = window.SUPABASE_ANON_KEY;
      const supabase = (supabaseUrl && supabaseAnon) ? window.supabase.createClient(supabaseUrl, supabaseAnon) : null;

      var currentAuth = null; // { type: 'jwt'|'key', value: tokenOrKey }

      try {
        var stored = sessionStorage.getItem(STORAGE_KEY);
        if (stored) keyInput.value = stored;
      } catch (_) {}

      function getBaseUrl() {
        var adminUrl = window.ADMIN_API_URL;
        if (adminUrl) return adminUrl.replace(/\/$/, "");
        var deleteUrl = window.DELETE_ACCOUNT_URL;
        if (deleteUrl) return deleteUrl.replace(/\/delete-my-account\/?$/, "");
        return "";
      }

      function showMessage(text, isError) {
        msgEl.textContent = text;
        msgEl.className = "message " + (isError ? "error" : "success");
        msgEl.style.display = "block";
      }

      function hideMessage() {
        msgEl.style.display = "none";
      }

      function authHeaders() {
        if (!currentAuth) return {};
        if (currentAuth.type === "jwt") return { Authorization: "Bearer " + currentAuth.value };
        var h = { "X-Admin-Key": currentAuth.value };
        if (totpInput && totpInput.value) {
          var code = totpInput.value.replace(/\D/g, "").slice(0, 6);
          if (code.length === 6) h["X-Admin-TOTP"] = code;
        }
        return h;
      }

      function setLoggedIn(email) {
        loggedInEmail.textContent = "Logged in as " + (email || "admin");
        loggedInSection.style.display = "block";
        loginSection.style.display = "none";
      }

      function setLoggedOut() {
        currentAuth = null;
        loggedInSection.style.display = "none";
        loginSection.style.display = "block";
        tableWrap.style.display = "none";
      }

      function loadUsers(onDone) {
        var base = getBaseUrl();
        if (!base) {
          showMessage("Set ADMIN_API_URL or DELETE_ACCOUNT_URL in config to the Worker base URL.", true);
          if (onDone) onDone(false);
          return;
        }
        var headers = authHeaders();
        if (!headers.Authorization && !headers["X-Admin-Key"]) {
          showMessage("Log in or enter the API key first.", true);
          if (onDone) onDone(false);
          return;
        }
        fetch(base + "/admin/users", { headers: headers })
          .then(function (res) {
            return res.json().then(function (data) { return { res: res, data: data }; });
          })
          .then(function (r) {
            if (!r.res.ok) {
              showMessage(r.data.error || "Failed to load users (" + r.res.status + ").", true);
              if (r.res.status === 401) setLoggedOut();
              tableWrap.style.display = "none";
              if (onDone) onDone(false);
              return;
            }
            var users = r.data.users || [];
            tbody.innerHTML = "";
            users.forEach(function (u) {
              var tr = document.createElement("tr");
              var email = (u.email || "").trim() || "—";
              var id = (u.id || "").trim() || "—";
              var created = u.created_at ? new Date(u.created_at).toLocaleString() : "—";
              tr.innerHTML =
                "<td>" + escapeHtml(email) + "</td>" +
                "<td class=\"meta\">" + escapeHtml(id) + "</td>" +
                "<td class=\"meta\">" + escapeHtml(created) + "</td>" +
                "<td><button type=\"button\" class=\"btn-del\">Delete</button></td>";
              tr.querySelector(".btn-del").addEventListener("click", function () {
                deleteUser(id, tr);
              });
              tbody.appendChild(tr);
            });
            tableWrap.style.display = "block";
            showMessage("Loaded " + users.length + " user(s).", false);
            if (onDone) onDone(true);
          })
          .catch(function (err) {
            showMessage(err.message || "Network error.", true);
            if (onDone) onDone(false);
          });
      }

      function escapeHtml(str) {
        if (str == null) return "";
        var s = String(str);
        return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#39;");
      }

      function deleteUser(userId, rowEl) {
        if (!confirm("Permanently delete this user? This cannot be undone.")) return;
        var btn = rowEl.querySelector(".btn-del");
        btn.disabled = true;
        var base = getBaseUrl();
        var headers = authHeaders();
        fetch(base + "/admin/users/" + encodeURIComponent(userId), { method: "DELETE", headers: headers })
          .then(function (res) {
            return res.json().then(function (data) { return { res: res, data: data }; });
          })
          .then(function (r) {
            if (r.res.ok) {
              rowEl.remove();
              showMessage("User deleted.", false);
            } else {
              showMessage(r.data.error || "Delete failed.", true);
              btn.disabled = false;
            }
          })
          .catch(function (err) {
            showMessage(err.message || "Network error.", true);
            btn.disabled = false;
          });
      }

      loadJwtBtn.addEventListener("click", function () {
        loadJwtBtn.disabled = true;
        hideMessage();
        loadUsers(function () { loadJwtBtn.disabled = false; });
      });

      logoutBtn.addEventListener("click", function () {
        if (supabase) supabase.auth.signOut();
        setLoggedOut();
        hideMessage();
      });

      loginForm.addEventListener("submit", function (e) {
        e.preventDefault();
        if (!supabase) {
          showMessage("Supabase config missing.", true);
          return;
        }
        var email = adminEmail.value.trim();
        var password = adminPassword.value;
        if (!email || !password) {
          showMessage("Enter email and password.", true);
          return;
        }
        hideMessage();
        loginForm.querySelector('button[type="submit"]').disabled = true;
        supabase.auth.signInWithPassword({ email: email, password: password })
          .then(function (r) {
            if (r.error) {
              showMessage(r.error.message || "Login failed.", true);
              loginForm.querySelector('button[type="submit"]').disabled = false;
              return;
            }
            var token = r.data.session?.access_token;
            if (!token) {
              showMessage("Login failed.", true);
              loginForm.querySelector('button[type="submit"]').disabled = false;
              return;
            }
            currentAuth = { type: "jwt", value: token };
            setLoggedIn(r.data.user?.email || email);
            adminPassword.value = "";
            loginForm.querySelector('button[type="submit"]').disabled = false;
            loadUsers();
          })
          .catch(function (err) {
            showMessage(err.message || "Login failed.", true);
            loginForm.querySelector('button[type="submit"]').disabled = false;
          });
      });

      loadKeyBtn.addEventListener("click", function () {
        var key = keyInput.value.trim();
        if (!key) {
          showMessage("Enter the Admin API key.", true);
          return;
        }
        try { sessionStorage.setItem(STORAGE_KEY, key); } catch (_) {}
        currentAuth = { type: "key", value: key };
        loadKeyBtn.disabled = true;
        hideMessage();
        loadUsers(function () { loadKeyBtn.disabled = false; });
      });

      if (supabase) {
        supabase.auth.getSession().then(function (r) {
          var session = r.data.session;
          var userEmail = r.data.user?.email || "";
          if (session && session.access_token) {
            currentAuth = { type: "jwt", value: session.access_token };
            loadUsers(function (success) {
              if (success) setLoggedIn(userEmail);
            });
          }
        });
      }
    })();
  </script>
</body>
</html>
