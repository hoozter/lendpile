<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <!-- Bump when you deploy so users see "New version available". When you say "update version", bump this too (e.g. match project version or increment). -->
  <meta name="app-version" content="0.2.0" />
  <link rel="icon" href="assets/favicon.ico" type="image/x-icon" />
  <meta name="color-scheme" content="light dark">
  <script>
    (function() {
      var saved = localStorage.getItem("theme");
      var dark = saved === "dark" || (!saved && window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches);
      if (dark) document.documentElement.setAttribute("data-theme", "dark");
    })();
  </script>
  <title>Lendpile</title>
  <!-- Google Fonts & Material Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=League+Spartan:wght@500&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <!-- Apache ECharts (reliable HTML tooltips, no canvas tooltip issues) -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <!-- Supabase Client (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Config (copy config.example.js to config.js; config.js is gitignored) -->
  <script src="config.js"></script>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <!-- MAIN HEADER -->
  <header class="main-header">
    <div class="header-content">
      <div class="logo-container">
        <img src="assets/lendpile.svg" alt="Lendpile" class="logo" />
      </div>
      <div class="controls-right">
        <div id="user-header-block" class="user-header-block">
          <button type="button" class="profile-icon-btn toolbar-btn" id="profile-icon-btn" title="Account" aria-haspopup="true" aria-expanded="false">
            <span class="material-icons">account_circle</span>
          </button>
          <div id="profile-dropdown" class="profile-dropdown" role="menu">
            <div class="profile-dropdown-email" id="profile-dropdown-email"></div>
            <button type="button" class="profile-dropdown-item" id="profile-account" role="menuitem">
              <span class="material-icons">person</span><span data-translate="account">Account</span>
            </button>
            <button type="button" class="profile-dropdown-item" id="profile-settings" role="menuitem">
              <span class="material-icons">settings</span><span data-translate="settings">Settings</span>
            </button>
            <a href="admin.html" class="profile-dropdown-item profile-admin-link" id="profile-admin" role="menuitem" style="display: none;">
              <span class="material-icons">admin_panel_settings</span><span data-translate="admin">Admin</span>
            </a>
            <button type="button" class="profile-dropdown-item" id="profile-logout" role="menuitem" data-translate="logOut">Log out</button>
          </div>
        </div>
        <div class="theme-control" role="group" aria-label="Theme">
          <span class="material-icons" id="themeIconLight" title="Light mode" aria-hidden="true">light_mode</span>
          <div class="toggle-switch">
            <input type="checkbox" id="theme-toggle" aria-label="Dark mode">
            <label for="theme-toggle"></label>
          </div>
          <span class="material-icons" id="themeIconDark" title="Dark mode" aria-hidden="true">dark_mode</span>
        </div>
      </div>
    </div>
  </header>
  
  <!-- MAIN CONTAINER -->
  <div class="container">
    <div id="transfer-offer-banner" class="transfer-offer-banner hidden" role="alert"></div>
    <div id="edit-request-banner" class="edit-request-banner hidden" role="alert"></div>
    <div id="edit-resolution-banner" class="edit-resolution-banner hidden" role="alert"></div>
    <div id="offline-banner" class="offline-banner hidden" role="status">
      <p class="offline-banner-text" id="offline-banner-text"></p>
      <button type="button" class="btn-primary offline-banner-btn" id="offline-banner-signin-btn"></button>
    </div>
    <div id="view-list" class="main-view">
      <section id="loan-info">
        <div id="list-summary" class="list-summary" aria-live="polite"></div>
        <div class="loan-info-header">
          <h2 data-translate="myLoans">Mina lån</h2>
          <button class="btn-add" id="add-loan-btn" data-translate="addLoan">Lägg till Lån</button>
        </div>
        <div id="loans-list">
          <p data-translate="noLoans">Inga lån registrerade. Lägg till ett nytt lån ovan.</p>
        </div>
      </section>
    </div>
    <div id="view-detail" class="main-view hidden">
      <p id="shared-by-line" class="shared-by-line hidden" aria-live="polite"></p>
      <div class="loan-detail-header">
        <button type="button" class="btn-back" id="back-to-loans" aria-label="Back to loans">
          <span class="material-icons">arrow_back</span>
          <span id="back-to-loans-text" data-translate="backToLoans">Tillbaka till lån</span>
        </button>
        <h2 id="loan-detail-name"></h2>
        <div class="loan-detail-header-spacer"></div>
        <div class="overview-detail-menu-wrap" id="loan-detail-header-menu-wrap" data-loan-index="">
          <button type="button" class="overview-detail-menu-btn" aria-haspopup="true" aria-expanded="false" title="Actions">
            <span class="material-icons">more_vert</span>
          </button>
          <div class="overview-detail-menu dropdown-menu" role="menu">
            <button type="button" role="menuitem" data-action="edit" data-translate="edit">Redigera</button>
            <button type="button" role="menuitem" data-action="share" data-translate="shareLoan">Dela lån</button>
            <button type="button" role="menuitem" data-action="duplicate" data-translate="duplicate">Duplicera</button>
            <button type="button" role="menuitem" data-action="delete" data-translate="delete">Ta bort</button>
          </div>
        </div>
      </div>
      <div class="loan-detail-tabs" role="tablist">
        <button type="button" class="loan-detail-tab active" data-tab="overview" role="tab" data-translate="overview">Översikt</button>
        <button type="button" class="loan-detail-tab" data-tab="amortizations" role="tab" data-translate="amortizationsTab">Amorteringar</button>
        <button type="button" class="loan-detail-tab" data-tab="target" role="tab" data-translate="payOffByDate">Betala av senast</button>
        <button type="button" class="loan-detail-tab" data-tab="chart" role="tab" data-translate="showChart">Visa graf</button>
      </div>
      <div id="loan-detail-content"></div>
    </div>
  </div>
  
  <!-- LOAN MODAL (Add/Edit Loan) -->
  <div id="loan-modal" class="modal">
    <div class="modal-content">
      <span class="btn-close">&times;</span>
      <h2 id="loan-modal-title" class="modal-main-title" data-translate="addLoan">Lägg till Lån</h2>
      <form id="loan-form-modal">
        <div class="modal-section">
          <h4 class="modal-section-title" data-translate="loanType">Lånetyp</h4>
          <div class="form-row">
            <div class="loan-type-toggle" role="group" aria-label="Loan type">
              <button type="button" id="loan-type-borrow" class="active" data-loan-type="borrow" data-translate="loanTypeBorrow">Jag lånar</button>
              <button type="button" id="loan-type-lend" data-loan-type="lend" data-translate="loanTypeLend">Jag lånar ut</button>
            </div>
            <input type="hidden" id="loanType" name="loanType" value="borrow" />
          </div>
        </div>
        <div class="modal-section">
          <h4 class="modal-section-title" data-translate="loanDetails">Låneuppgifter</h4>
          <div class="form-row">
            <label for="loanName" data-translate="loanName">Lånenamn:</label>
            <div id="loanName-container" class="loan-field-wrap">
              <input type="text" id="loanName" required placeholder="Ex. Bolån" />
            </div>
          </div>
          <div class="form-row">
            <label for="loanStartDate" data-translate="startDate">Startdatum:</label>
            <div id="loanStartDate-container" class="locked-field-container loan-field-wrap">
              <input type="date" id="loanStartDate" required placeholder="YYYY-MM-DD" disabled />
            </div>
          </div>
          <div class="form-row">
            <label for="loanInitialAmount" data-translate="loanAmount">Ursprungligt lånebelopp:</label>
            <div id="loanInitialAmount-container" class="locked-field-container loan-field-wrap">
              <input type="number" id="loanInitialAmount" required min="0" placeholder="Ex. 300000" disabled />
            </div>
          </div>
          <div class="form-row">
            <label for="loanCurrency" data-translate="currency">Valuta:</label>
            <div id="loanCurrency-container" class="loan-field-wrap">
              <select id="loanCurrency" required>
              <option value="SEK">SEK</option>
              <option value="EUR">EUR</option>
              <option value="USD">USD</option>
              <option value="NOK">NOK</option>
              <option value="DKK">DKK</option>
            </select>
            </div>
          </div>
          <div class="form-row hidden" id="loan-initial-interest-row">
            <label for="loanInitialInterestRate" data-translate="initialInterestRate">Initial interest rate (%)</label>
            <input type="number" id="loanInitialInterestRate" step="any" min="0" placeholder="e.g. 4.5" />
          </div>
        </div>
        <div class="modal-section">
          <h4 class="modal-section-title" data-translate="interest">Ränta</h4>
          <p class="form-section-help hidden" id="interest-section-help"></p>
          <div id="interest-changes-list"></div>
          <button type="button" id="add-interest-change-btn" class="btn-add" data-change-type="interest" data-translate="addInterestChange">Lägg till ränteförändring</button>
        </div>
        <div class="modal-section">
          <h4 class="modal-section-title" data-translate="loanChanges">Låneförändringar</h4>
          <p class="form-section-help hidden" id="loan-changes-section-help"></p>
          <div id="loan-changes-list"></div>
          <button type="button" id="add-loan-change-btn" class="btn-add" data-change-type="loan" data-translate="addLoanChange">Lägg till låneförändring</button>
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn-primary" data-translate="save">Spara Lån</button>
          <button type="button" class="btn-delete" id="remove-loan-btn" data-translate="removeLoan">Ta bort Lån</button>
          <div class="modal-lock-control locked" id="globalLockControl">
            <span class="material-icons">lock</span>
            <span class="lock-text" data-translate="unlockSensitiveFields">Lås upp känsliga fält</span>
          </div>
        </div>
      </form>
    </div>
  </div>
  
  <!-- AMORTIZATION MODAL (Add/Edit Amortization) -->
  <div id="amortization-modal" class="modal">
    <div class="modal-content">
      <span class="btn-close">&times;</span>
      <h2 id="amortization-modal-title" class="modal-main-title" data-translate="addAmortization">Lägg till Amortering</h2>
      <form id="amortization-form-modal">
        <input type="hidden" id="amortizationLoanId" />
        <input type="hidden" id="amortizationId" />
        <div class="modal-section">
          <h4 class="modal-section-title" data-translate="paymentDetails">Betalningsuppgifter</h4>
          <div class="form-row">
            <label for="amortizationAmount" data-translate="amount">Belopp:</label>
            <div class="locked-field-container">
              <input type="number" id="amortizationAmount" required min="0" placeholder="Ex. 300000" disabled>
            </div>
          </div>
          <div class="form-row">
            <label for="amortizationStartDate" data-translate="startDate">Startdatum:</label>
            <div class="unlocked-field-container">
              <input type="date" id="amortizationStartDate" required />
            </div>
          </div>
          <div class="form-row">
            <label for="amortizationType" data-translate="type">Typ:</label>
            <select id="amortizationType" required>
              <option value="one-time" data-translate="oneTimeAmortization">Engångsamortering</option>
              <option value="scheduled" data-translate="scheduledAmortization">Schemalagd Amortering</option>
            </select>
            <p class="amortization-type-help" data-translate="extraPaymentTypeHelp">Engångs = en extra betalning en månad. Schemalagd = återkommande extra betalning.</p>
          </div>
        </div>
        <div class="modal-section">
          <h4 class="modal-section-title" data-translate="schedule">Schema</h4>
        <div id="amortization-schedule-options" class="schedule-options">
          <div class="recurrence-pattern">
            <span class="material-icons recurrence-icon">sync</span>
            <div class="pattern-options">
              <div class="pattern-row recurrence-interval-row">
                <span data-translate="repeatEvery">Upprepa var</span>
                <select id="amortizationFrequency" class="recurrence-interval" aria-label="Recurrence interval">
                  <option value="1" selected>1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                  <option value="7">7</option>
                  <option value="8">8</option>
                  <option value="9">9</option>
                  <option value="10">10</option>
                  <option value="11">11</option>
                  <option value="12">12</option>
                </select>
                <select id="amortizationFrequencyUnit" class="recurrence-unit" aria-label="Recurrence unit">
                  <option value="month" selected data-translate="everyMonth">månad</option>
                  <option value="week" data-translate="everyWeek">vecka</option>
                </select>
              </div>
              <div id="schedule-when-month" class="pattern-row when-options">
                <span class="when-label" data-translate="payOnDay">Betalning dag</span>
                <input type="radio" id="dayOfMonth" name="monthPattern" checked />
                <label for="dayOfMonth"><span data-translate="dayOfMonth">Dag</span> <span id="selectedDay" class="selected-day"></span> <span data-translate="ofMonth">i månaden</span></label>
                <input type="radio" id="lastDayBeforeWeekend" name="monthPattern" />
                <label for="lastDayBeforeWeekend" data-translate="lastDayBeforeWeekend">Sista vardagen i månaden</label>
              </div>
              <div id="schedule-when-week" class="pattern-row when-options hidden">
                <span class="when-label" data-translate="sameWeekdayAsStart">Samma veckodag som start (t.ex. tisdag)</span>
                <span id="selectedWeekday" class="selected-weekday"></span>
              </div>
            </div>
          </div>
          <div class="range-pattern">
            <span class="material-icons range-icon">date_range</span>
            <div class="range-options">
              <div class="summary-text" id="schedule-summary-text" aria-live="polite">
                <span id="occurrenceSummary"></span>
                <span id="endDateSummary" class="end-date-text"></span>
              </div>
              <div class="end-date-section">
                <label for="amortizationEndDate" data-translate="endDate">Slutdatum (valfritt)</label>
                <input type="date" id="amortizationEndDate" />
              </div>
            </div>
          </div>
        </div>
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn-primary" data-translate="save">Spara</button>
          <button type="button" class="btn-delete" id="remove-amortization-btn" data-translate="removeAmortization">Ta bort Amortering</button>
          <div class="modal-lock-control locked" id="amortizationGlobalLockControl">
            <span class="material-icons">lock</span>
            <span class="lock-text" data-translate="unlockSensitiveFields">Lås upp känsliga fält</span>
          </div>
        </div>
      </form>
    </div>
  </div>
  
  <!-- UNIFIED CHANGE MODAL (for Interest and Loan Changes) -->
  <div id="add-change-modal" class="modal">
    <div class="modal-content">
      <span class="btn-close">&times;</span>
      <h2 id="change-modal-title" class="modal-main-title"></h2>
      <form id="change-form">
        <input type="hidden" id="changeType" value="" />
        <div class="modal-section">
          <div class="form-row">
            <label for="changeDate" data-translate="startDate">Datum (YYYY-MM-DD):</label>
            <input type="date" id="changeDate" required />
          </div>
          <div class="form-row">
            <label for="changeValue" id="changeValueLabel"></label>
            <input type="number" id="changeValue" step="0.01" required />
          </div>
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn-primary" data-translate="save">Spara</button>
          <button type="button" class="btn-delete" id="cancel-change-btn" data-translate="cancel">Avbryt</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- DELETE CONFIRMATION MODAL -->
  <div id="delete-confirmation-modal" class="confirm-modal modal">
    <div class="modal-content">
      <span class="btn-close">&times;</span>
      <h2 class="modal-main-title" data-translate="confirmDelete">Bekräfta Radering</h2>
      <p class="modal-message" data-translate="deleteConfirmMessage">Är du säker på att du vill ta bort denna post?</p>
      <div class="modal-actions">
        <button id="confirm-delete-btn" class="btn-delete" data-translate="delete">Ta bort</button>
        <button id="cancel-delete-btn" class="btn-primary" data-translate="cancel">Avbryt</button>
      </div>
    </div>
  </div>

  <!-- REMOVE SHARED LOAN FROM LIST MODAL -->
  <div id="remove-shared-loan-modal" class="confirm-modal modal">
    <div class="modal-content">
      <span class="btn-close">&times;</span>
      <h2 class="modal-main-title" id="remove-shared-loan-title"></h2>
      <p class="modal-message" id="remove-shared-loan-message"></p>
      <div class="modal-actions">
        <button id="confirm-remove-shared-btn" class="btn-primary"></button>
        <button id="cancel-remove-shared-btn" class="btn-primary" data-translate="cancel">Cancel</button>
      </div>
    </div>
  </div>

  <!-- GENERIC CONFIRM (replaces JS confirm() for revoke, transfer, disable 2FA, etc.) -->
  <div id="generic-confirm-modal" class="confirm-modal modal">
    <div class="modal-content">
      <span class="btn-close">&times;</span>
      <h2 class="modal-main-title" id="generic-confirm-title"></h2>
      <p class="modal-message" id="generic-confirm-message"></p>
      <div class="modal-actions">
        <button id="generic-confirm-btn" class="btn-primary"></button>
        <button id="generic-confirm-cancel-btn" class="btn-primary" data-translate="cancel">Cancel</button>
      </div>
    </div>
  </div>

  <!-- NEW VERSION AVAILABLE (prompt to refresh) -->
  <div id="update-available-modal" class="confirm-modal modal">
    <div class="modal-content">
      <span class="btn-close">&times;</span>
      <h2 class="modal-main-title" data-translate="newVersionAvailable">New version available</h2>
      <p class="modal-message" data-translate="newVersionAvailableMessage">There is a new version of this page available. Press Update to load it.</p>
      <div class="modal-actions">
        <button id="update-available-refresh-btn" class="btn-primary" data-translate="updateToLoad">Update</button>
      </div>
    </div>
  </div>
  
  <!-- UNLOCK CONFIRMATION MODAL -->
  <div id="unlock-confirmation-modal" class="modal">
    <div class="modal-content">
      <span class="btn-close">&times;</span>
      <h2 class="modal-main-title" data-translate="warning">Varning - Känsligt Fält</h2>
      <div class="modal-section">
        <p data-translate="unlockWarningMessage">Att ändra detta värde kan påverka:</p>
        <ul class="modal-list">
          <li data-translate="historyCalc">Historiska beräkningar</li>
          <li data-translate="futurePred">Framtida prognoser</li>
          <li data-translate="amortPlans">Amorteringsplaner</li>
        </ul>
        <p data-translate="confirmChange">Är du säker på att du vill göra denna ändring?</p>
      </div>
      <div class="modal-actions">
        <button id="confirm-unlock-btn" data-translate="tempUnlock">Lås upp tillfälligt</button>
        <button id="cancel-unlock-btn" data-translate="cancel">Avbryt</button>
      </div>
    </div>
  </div>
  
  <!-- ACCOUNT MODAL -->
  <div id="account-modal" class="modal">
    <div class="modal-content">
      <span class="btn-close">&times;</span>
      <h2 class="modal-main-title" data-translate="account">Konto</h2>
      <div class="modal-section" id="account-settings-section">
        <h4 class="account-subtitle" data-translate="email">E‑post</h4>
        <div id="account-email-list" class="account-email-list"></div>
        <div class="account-email-add-wrap hidden" id="account-email-add-wrap">
          <input type="email" id="account-new-secondary-email" placeholder="" autocomplete="email">
          <div class="account-email-add-actions">
            <button type="button" class="btn-primary account-add-email-btn" data-translate="save">Spara</button>
            <button type="button" class="btn-secondary account-cancel-add-email" data-translate="cancel">Avbryt</button>
          </div>
        </div>
        <button type="button" class="btn-secondary account-add-email-link" id="account-add-email-link" data-translate="addAnotherEmail">Lägg till annan e‑post</button>
        <div class="account-change-email-inline hidden" id="account-change-email-inline">
          <input type="email" id="account-new-email" placeholder="" autocomplete="email">
          <div class="account-email-actions">
            <button type="button" class="btn-primary account-send-email-change" data-translate="sendVerification">Skicka verifiering</button>
            <button type="button" class="btn-secondary account-cancel-email-change" data-translate="cancel">Avbryt</button>
          </div>
        </div>
        <p class="account-field-help account-email-feedback hidden" id="account-email-change-feedback"></p>

        <h4 class="account-subtitle" data-translate="displayName">Visningsnamn</h4>
        <div class="account-row account-row-align">
          <input type="text" id="account-display-name" placeholder="" maxlength="100" autocomplete="name">
          <button type="button" class="btn-primary account-save-display-name" data-translate="save">Spara</button>
        </div>
        <p class="account-field-help" data-translate="displayNameHelp">Används t.ex. när du delar ett lån: &quot;David delar ett lån&quot;.</p>

        <h4 class="account-subtitle" data-translate="security">Säkerhet</h4>
        <div class="account-security-row">
          <span class="account-security-label" data-translate="changePassword">Byt lösenord</span>
          <button type="button" class="btn-secondary account-change-password-btn" id="account-change-password-btn" data-translate="changePassword">Byt lösenord</button>
        </div>
        <div class="account-security-row">
          <span class="account-security-label" data-translate="twoFactorAuth">Tvåfaktorsautentisering (2FA)</span>
          <div class="account-mfa-actions">
            <button type="button" class="btn-primary account-mfa-enable" id="account-mfa-enable" data-translate="enable2FA">Aktivera 2FA</button>
            <button type="button" class="btn-secondary account-mfa-disable hidden" id="account-mfa-disable" data-translate="disable2FA">Inaktivera 2FA</button>
          </div>
        </div>
        <p class="account-field-help" data-translate="twoFactorHelp">Skanna QR‑koden med en autentiseringsapp för extra säkerhet.</p>

        <h4 class="account-subtitle" data-translate="dataAndPrivacy">Data och konto</h4>
        <button type="button" class="btn-secondary account-export-data-btn" id="account-export-data-btn" data-translate="exportAllData">Exportera all data</button>
        <button type="button" class="btn-delete account-delete-account-btn" id="account-delete-account-btn" data-translate="deleteAccount">Ta bort konto</button>
      </div>
    </div>
  </div>

  <!-- DELETE ACCOUNT CONFIRMATION MODAL -->
  <div id="delete-account-modal" class="modal">
    <div class="modal-content">
      <span class="btn-close">&times;</span>
      <h2 class="modal-main-title" data-translate="deleteAccount">Ta bort konto</h2>
      <p class="delete-account-warning" data-translate="deleteAccountWarning">All din data (lån, inställningar och konto) raderas permanent och kan inte återställas. Detta går inte att ångra.</p>
      <p class="delete-account-confirm" data-translate="deleteAccountConfirm">Skriv in ditt lösenord och skriv DELETE i rutan nedan för att bekräfta.</p>
      <form id="delete-account-form">
        <div class="login-form-group">
          <label for="delete-account-password" data-translate="password">Lösenord</label>
          <input type="password" id="delete-account-password" required autocomplete="current-password">
        </div>
        <div class="login-form-group">
          <label for="delete-account-type-delete" data-translate="deleteAccountTypeDelete">Skriv DELETE för att bekräfta</label>
          <input type="text" id="delete-account-type-delete" required autocomplete="off" placeholder="DELETE">
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn-delete" id="delete-account-submit" data-translate="deleteMyAccount">Ta bort mitt konto</button>
          <button type="button" class="btn-primary" id="delete-account-cancel" data-translate="cancel">Avbryt</button>
        </div>
      </form>
      <div id="delete-account-feedback" class="mfa-feedback"></div>
    </div>
  </div>

  <!-- SETTINGS MODAL (app: language, currency, start page, data, privacy) -->
  <div id="settings-modal" class="modal">
    <div class="modal-content">
      <span class="btn-close">&times;</span>
      <h2 class="modal-main-title" data-translate="settings">Inställningar</h2>
      <div class="modal-section">
        <h4 class="modal-section-title" data-translate="language">Språk</h4>
        <div class="form-row">
          <select id="language-select">
            <option value="sv">Svenska</option>
            <option value="en">English</option>
          </select>
        </div>
      </div>
      <div class="modal-section">
        <h4 class="modal-section-title" data-translate="defaultCurrency">Standardvaluta</h4>
        <div class="form-row">
          <select id="currency-select">
            <option value="SEK">SEK</option>
            <option value="EUR">EUR</option>
            <option value="USD">USD</option>
            <option value="GBP">GBP</option>
          </select>
        </div>
      </div>
      <div class="modal-section" id="start-page-settings-section">
        <h4 class="modal-section-title" data-translate="startPage">Startsida</h4>
        <p class="start-page-description" data-translate="startPageDescription">Välj vad som ska visas i översikten och vilka lån som ska ingå i summeringen.</p>
        <div class="form-row">
          <span class="start-page-subtitle" data-translate="showOnStartPage">Visa på startsidan</span>
        </div>
        <div class="start-page-blobs">
          <label class="start-page-checkbox-label">
            <input type="checkbox" id="start-page-blob-monthly" checked>
            <span data-translate="showTotalMonthly">Total månadsbetalning</span>
          </label>
          <label class="start-page-checkbox-label">
            <input type="checkbox" id="start-page-blob-debt" checked>
            <span data-translate="showTotalDebt">Total skuld</span>
          </label>
          <label class="start-page-checkbox-label">
            <input type="checkbox" id="start-page-blob-monthly-incoming" checked>
            <span data-translate="showMonthlyIncoming">Månadsinkomst (lån ut)</span>
          </label>
          <label class="start-page-checkbox-label">
            <input type="checkbox" id="start-page-blob-owed" checked>
            <span data-translate="showOwedToYou">Till dig (lån ut)</span>
          </label>
          <label class="start-page-checkbox-label">
            <input type="checkbox" id="start-page-blob-count" checked>
            <span data-translate="showLoanCount">Antal lån</span>
          </label>
        </div>
        <div class="form-row form-row-spaced">
          <span class="start-page-subtitle" data-translate="includeInSummary">Ingå i summering</span>
        </div>
        <div id="start-page-loans-list" class="start-page-loans-list"></div>
      </div>
      <div class="modal-section">
        <h4 class="modal-section-title" data-translate="dataManagement">Datahantering</h4>
        <div class="data-export">
          <h4 class="modal-section-subtitle" data-translate="exportLoans">Exportera lån</h4>
          <p class="account-field-help" data-translate="exportLoansHelp">Välj vilka lån som ska ingå i exporten.</p>
          <label class="export-select-all-label">
            <input type="checkbox" id="export-select-all" class="export-select-all-checkbox">
            <span data-translate="selectAllLoans">Välj alla lån</span>
          </label>
          <div id="loan-export-list" class="loan-export-list"></div>
          <button id="btn-export" class="btn-primary" data-translate="exportSelectedLoans">Exportera valda lån</button>
          <p id="export-loans-feedback" class="account-field-help hidden"></p>
        </div>
        <div class="data-import">
          <h4 class="modal-section-subtitle" data-translate="importLoans">Importera lån</h4>
          <p class="account-field-help" data-translate="importLoansHelp">Välj en JSON-fil med lån (export från Lendpile eller array av lån).</p>
          <input type="file" id="btn-import-file" class="hidden" accept=".json" />
          <button id="btn-import-data" class="btn-primary" data-translate="selectFile">Välj Fil</button>
        </div>
      </div>
      <div class="modal-section">
        <h4 class="modal-section-title" data-translate="privacyAndLegal">Privacy &amp; legal</h4>
        <p class="start-page-description"><a href="privacy.html" target="_blank" rel="noopener noreferrer" data-translate="privacyPolicy">Privacy policy &amp; GDPR</a></p>
        <p class="start-page-description"><a href="faq.html" target="_blank" rel="noopener noreferrer" data-translate="helpAndFaq">Help &amp; FAQ</a></p>
        <p class="start-page-description start-page-description-spaced"><a href="https://github.com/hoozter/lendpile" target="_blank" rel="noopener noreferrer" data-translate="sourceCode">Source code (GitHub)</a></p>
      </div>
    </div>
  </div>
  
  <!-- FEEDBACK MODAL -->
  <div id="feedback-modal" class="modal">
    <div class="modal-content feedback-content">
      <div class="feedback-message">
        <i class="material-icons">check_circle</i>
        <p data-translate="settingsSaved">Inställningarna har sparats!</p>
      </div>
    </div>
  </div>

  <!-- SECURITY PROMPT (combined 2FA + recovery, or 2FA-only; content set in maybeShowSecurityPrompt) -->
  <div id="security-prompt-modal" class="modal">
    <div class="modal-content">
      <span class="btn-close" id="security-prompt-close">&times;</span>
      <h2 class="modal-main-title" id="security-prompt-title">Secure your account</h2>
      <p class="account-field-help" id="security-prompt-body">Add two-factor authentication (2FA) and a recovery email.</p>
      <div class="modal-actions">
        <button type="button" class="btn-primary" id="security-prompt-setup" data-translate="securityPromptSetUpNow">Set up now</button>
        <button type="button" class="btn-secondary" id="security-prompt-later" data-translate="securityPromptMaybeLater">Maybe later</button>
        <button type="button" class="btn-secondary" id="security-prompt-dismiss" data-translate="securityPromptDontAskAgain">Don't ask again</button>
      </div>
    </div>
  </div>

  <!-- SHARE LOAN MODAL -->
  <div id="share-loan-modal" class="modal">
    <div class="modal-content">
      <span class="btn-close" id="share-modal-close">&times;</span>
      <h2 class="modal-main-title" data-translate="shareLoan">Dela lån</h2>
      <p class="account-field-help" data-translate="shareLoanHelp">Skapa en tidsbegränsad, engångslänk. Mottagaren ser vem som delar och kan öppna lånet (endast visa eller redigera).</p>
      <p class="account-field-help share-display-name-hint" data-translate="shareDisplayNameHint">Recipients will see your display name when they open the link. If you haven't set one, your email address will be shown instead. You can set a display name in Account.</p>
      <div class="modal-section">
        <h4 class="modal-section-subtitle" data-translate="sharePermission">Behörighet</h4>
        <div class="form-row share-options">
          <label><input type="radio" name="share-permission" value="view" checked> <span data-translate="shareViewOnly">Endast visa</span></label>
          <label><input type="radio" name="share-permission" value="edit"> <span data-translate="shareCanEdit">Kan redigera</span></label>
        </div>
        <h4 class="modal-section-subtitle" data-translate="shareRecipientView">Mottagaren är:</h4>
        <div class="form-row share-options">
          <label><input type="radio" name="share-recipient-view" value="borrowing" checked> <span data-translate="shareBorrowing">Låntagare</span></label>
          <label><input type="radio" name="share-recipient-view" value="lending"> <span data-translate="shareLending">Långivare</span></label>
        </div>
        <h4 class="modal-section-subtitle" data-translate="shareExpires">Länken går ut</h4>
        <select id="share-expires-days">
          <option value="1">1 dag</option>
          <option value="7" selected>7 dagar</option>
          <option value="14">14 dagar</option>
          <option value="30">30 dagar</option>
        </select>
      </div>
      <div id="share-active-list-section" class="share-active-list-section hidden">
        <h4 class="modal-section-subtitle" data-translate="activeSharesForThisLoan">Aktiva länkar för detta lån</h4>
        <div id="share-active-list" class="share-active-list"></div>
      </div>
      <div class="modal-actions">
        <button type="button" id="share-create-link-btn" class="btn-primary" data-translate="shareCreateLink">Skapa länk</button>
      </div>
      <div id="share-link-result" class="share-link-result hidden">
        <p class="account-field-help" data-translate="shareLinkCreated">Länk skapad. Dela den endast med den du vill ska se lånet.</p>
        <div class="share-link-input-wrap">
          <input type="text" id="share-link-url" readonly class="share-link-input" />
          <button type="button" id="share-copy-link-btn" class="btn-primary" data-translate="copyLink">Kopiera länk</button>
        </div>
        <p id="share-link-feedback" class="account-field-help hidden"></p>
      </div>
    </div>
  </div>
  
  <!-- LOGIN MODAL (Log in + Create account panes) -->
  <div id="login-modal" class="modal">
    <div class="modal-content">
      <span class="btn-close" id="login-modal-close">&times;</span>
      <div id="login-share-landing" class="login-share-landing hidden">
        <p id="login-share-preview-text" class="login-share-preview-text"></p>
        <p id="login-share-invalid-text" class="login-share-invalid-text hidden" data-translate="sharedLinkExpired">This link has expired or is invalid.</p>
      </div>
      <div id="login-pane" class="login-pane">
        <div class="login-header">
          <h2 data-translate="loginTitle">Log in</h2>
          <p data-translate="loginSubtitle">Sign in to sync your loans across devices.</p>
        </div>
        <form id="login-form">
          <div class="login-form-group">
            <label for="login-email" data-translate="email">Email</label>
            <input type="email" id="login-email" required placeholder="name@example.com" autocomplete="email">
          </div>
          <div class="login-form-group">
            <label for="login-password" data-translate="password">Password</label>
            <input type="password" id="login-password" required placeholder="••••••••" autocomplete="current-password">
          </div>
          <div class="login-actions">
            <button type="submit" class="btn-primary" data-translate="login">Log in</button>
            <div id="login-continue-without-wrap" class="login-continue-without-wrap">
              <div class="login-divider" data-translate="or">or</div>
              <div class="login-skip-wrap">
                <button type="button" class="login-skip-btn" id="work-offline-btn" data-translate="continueWithoutAccount">Continue without an account</button>
              </div>
            </div>
            <p class="login-switch-wrap">
              <button type="button" class="login-switch-link" id="login-to-signup-link" data-translate="noAccountCreateOne"></button>
            </p>
          </div>
        </form>
      </div>
      <div id="signup-pane" class="signup-pane hidden">
        <div class="login-header">
          <h2 data-translate="signUp">Create account</h2>
          <p data-translate="signUpSubtitle">Enter your email and choose a password to save and sync your loans.</p>
        </div>
        <form id="signup-form">
          <div class="login-form-group">
            <label for="signup-email" data-translate="email">Email</label>
            <input type="email" id="signup-email" required placeholder="name@example.com" autocomplete="email">
          </div>
          <div class="login-form-group">
            <label for="signup-display-name"><span data-translate="displayNameOptional">Display name (optional)</span></label>
            <input type="text" id="signup-display-name" placeholder="" autocomplete="name" maxlength="200">
            <p class="login-field-hint" data-translate="displayNameUsedForSharing">Shown when you share loans with others.</p>
          </div>
          <div class="login-form-group">
            <label for="signup-password" data-translate="choosePassword">Choose a password</label>
            <input type="password" id="signup-password" required minlength="8" placeholder="••••••••" autocomplete="new-password">
          </div>
          <div class="login-form-group">
            <label for="signup-password-confirm" data-translate="confirmPassword">Confirm password</label>
            <input type="password" id="signup-password-confirm" required minlength="8" placeholder="••••••••" autocomplete="new-password">
          </div>
          <div class="login-actions">
            <button type="submit" class="btn-primary" id="signup-submit-btn" data-translate="signUp">Create account</button>
            <p class="login-switch-wrap">
              <button type="button" class="login-switch-link" id="signup-to-login-link" data-translate="haveAccountLogIn"></button>
            </p>
          </div>
        </form>
      </div>
      <div id="login-feedback" class="login-feedback-common"></div>
    </div>
  </div>
  
  <!-- CHANGE PASSWORD MODAL -->
  <div id="change-password-modal" class="modal">
    <div class="modal-content">
      <span class="btn-close">&times;</span>
      <h2 data-translate="changePassword">Change password</h2>
      <p class="password-requirements" data-translate="passwordRequirements">At least 8 characters, upper and lower case, and a number or special character.</p>
      <form id="change-password-form">
        <div class="login-form-group">
          <label for="current-password" data-translate="currentPassword">Current password</label>
          <input type="password" id="current-password" required autocomplete="current-password">
        </div>
        <div class="login-form-group">
          <label for="new-password" data-translate="newPassword">New password</label>
          <input type="password" id="new-password" required minlength="8" autocomplete="new-password">
        </div>
        <div class="login-form-group">
          <label for="confirm-password" data-translate="confirmPassword">Confirm new password</label>
          <input type="password" id="confirm-password" required minlength="8" autocomplete="new-password">
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn-primary" data-translate="save">Save</button>
          <button type="button" class="btn-primary" id="change-password-cancel" data-translate="cancel">Cancel</button>
        </div>
      </form>
      <div id="change-password-feedback"></div>
    </div>
  </div>
  
  <!-- MFA ENROLL MODAL (Settings: enable 2FA) -->
  <div id="mfa-enroll-modal" class="modal">
    <div class="modal-content">
      <span class="btn-close">&times;</span>
      <h2 data-translate="enable2FA">Enable 2FA</h2>
      <p data-translate="mfaEnrollSteps">Scan the QR code with your authenticator app, then enter the 6‑digit code below.</p>
      <div id="mfa-enroll-qr" class="mfa-qr-container"></div>
      <div class="mfa-secret-wrap hidden" id="mfa-secret-wrap">
        <p class="mfa-secret-label" data-translate="cantScanQR">Can't scan? Enter this key manually in your app:</p>
        <div class="mfa-secret-row">
          <code id="mfa-enroll-secret" class="mfa-secret-code"></code>
          <button type="button" class="btn-secondary mfa-copy-secret" id="mfa-copy-secret" data-translate="copySecret">Copy key</button>
        </div>
      </div>
      <div class="login-form-group">
        <label for="mfa-enroll-code" data-translate="verificationCode">Verification code</label>
        <input type="text" id="mfa-enroll-code" inputmode="numeric" pattern="[0-9]*" maxlength="6" placeholder="000000" autocomplete="one-time-code">
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-primary" id="mfa-enroll-verify" data-translate="enable2FA">Enable 2FA</button>
        <button type="button" class="btn-primary" id="mfa-enroll-cancel" data-translate="cancel">Cancel</button>
      </div>
      <div id="mfa-enroll-feedback" class="mfa-feedback"></div>
    </div>
  </div>
  
  <!-- MFA CHALLENGE MODAL (Login: enter code) -->
  <div id="mfa-challenge-modal" class="modal">
    <div class="modal-content">
      <span class="btn-close" id="mfa-challenge-close">&times;</span>
      <h2 data-translate="twoFactorAuth">Two-factor authentication</h2>
      <p data-translate="mfaChallengePrompt">Enter the 6‑digit code from your authenticator app.</p>
      <form id="mfa-challenge-form">
        <div class="login-form-group">
          <label for="mfa-challenge-code" data-translate="verificationCode">Verification code</label>
          <input type="text" id="mfa-challenge-code" inputmode="numeric" pattern="[0-9]*" maxlength="6" placeholder="000000" autocomplete="one-time-code">
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn-primary" data-translate="verify">Verify</button>
        </div>
      </form>
      <div id="mfa-challenge-feedback" class="mfa-feedback"></div>
    </div>
  </div>
  
  <script src="app.js"></script>
</body>
</html>
